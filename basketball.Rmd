---
title: "Final Project Draft"
subtitle: "due Thursday, Oct 29 at 11:59p"
author: "Late Round Sleepers: Alex Jackson, Evan Finley, Jack White, Aliya Kamran"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
```

## Environment and Libraries

```{r environ}
library(tidyverse)
nba_players <- read.csv("https://projects.fivethirtyeight.com/nba-model/2020/latest_RAPTOR_by_team.csv")
```

### 1: Introduction

We are investigating what makes NBA players successful in various seasons. We
are all NBA fans and looking into statistics about the NBA will allow us to 
have a better understanding for the game and make us more informed. 
Basketball statistics are fairly new and it will be interesting to discover if
our perceived notions of certain players match the statistical data. 

In particular, we want to test the following hypothesis and questions:

If defensive or offensive efficiency affects winning percentage the
most.

Better defensive players have a better winning percentage in the playoffs and 
regular season.

Players who score the most do not have the highest winning percentage.

Players who have the most offensive possessions win more games.

Sources:
https://fivethirtyeight.com/features/introducing-raptor-our-new-metric-for-the-modern-nba/


### 2: Data description


We wish to explore the NBA-Raptor data set. Raptor is a player efficiency rating 
system.This data set has tracked multiple team and player analysis over a six 
year period. Each observation is an NBA player with variables about their 
statistics. It has variables such as players points per game, team winning 
percentage, average team possessions per game, and many more. The player data
is stats from every NBA games since 2014. Raptor was made by Fivethirtyeight. 


### 3: Glimpse of data

```{r glimpse}
glimpse(nba_players)
```

### 4: Methodology

The methodology section should include the variables used to address your 
research question, as well as any useful visualizations or summary statistics. 
As well, you should introduce and justify the statistical method(s) that you 
believe will be useful in answering your research question.


### 5: Results

Showcase how you arrived at answers to your question using any techniques we have 
learned in this class (and some beyond, if youâ€™re feeling adventurous). Provide 
the main results from your analysis. The goal is not to do an exhaustive data 
analysis (i.e., do not calculate every statistic and procedure you have learned 
for every variable), but rather let me know that you are proficient at asking 
meaningful questions and answering them with results of data analysis, that you 
are proficient in using R, and that you are proficient at interpreting and 
presenting the results. Focus on methods that help you begin to answer your 
research questions.


### 6: Adding Variables and Cleaning Data

```{r variables}
nba_players <- nba_players %>% 
  mutate(player_type = case_when(raptor_offense > 0 & raptor_defense > 0 ~ 
                                   "Two-way",
                                raptor_offense > 0 & raptor_defense < 0 ~ 
                                  "Offensive",
                                raptor_offense < 0 & raptor_defense > 0 ~ 
                                  "Defensive",
                                raptor_offense < 0 & raptor_defense < 0 ~ 
                                  "No-way"),
         team_win_pc = case_when(
      team == "MIL" ~ .767,
      team == "TOR" ~ .736,
      team == "BOS" ~ .667,
      team == "IND" ~ .616,
      team == "MIA" ~ .603,
      team == "PHI" ~ .589,
      team == "BRK" ~ .486,
      team == "ORL" ~ .452,
      team == "WAS" ~ .347,
      team == "CHA" ~ .354,
      team == "CHI" ~ .338,
      team == "NYK" ~ .318,
      team == "DET" ~ .303,
      team == "ATL" ~ .299,
      team == "CLE" ~ .292,
      team == "LAL" ~ .732,
      team == "LAC" ~ .681,
      team == "DEN" ~ .630,
      team == "HOU" ~ .611,
      team == "OKC" ~ .611,
      team == "UTA" ~ .611,
      team == "DAL" ~ .573,
      team == "POR" ~ .473,
      team == "MEM" ~ .466,
      team == "PHO" ~ .466,
      team == "SAS" ~ .451,
      team == "SAC" ~ .431,
      team == "NOP" ~ .417,
      team == "MIN" ~ .297,
      team == "GSW" ~ .231))
```

Added the following variables to our dataset:

player_type: categorizing the player as offensive, defensive etc.

team_win_pc: gives each player their associated win percentage. 

### Visualizations
```{r visualization}
#raptor visualization
ggplot(data = nba_players, aes(x = raptor_defense, y = raptor_offense)) +
  geom_point() + geom_hline(yintercept = 0, lwd = 1, col = "red", lty = 2) +
  geom_vline(xintercept = 0, lwd = 1, col = "red", lty = 2)+facet_wrap(~season_type) +
  labs(title = "Distrobution of NBA Players", 
       subtitle = "With the first quadrant being the target area for any player",
       y= "Offensive Raptor Grade", x = "Defensive Raptor Grade")

#all NBA
all_nba <- nba_players %>% 
  filter(player_name == "Giannis Antetokounmpo" |
         player_name == "LeBron James" |
         player_name == "James Harden" |
         player_name == "Anthony Davis" |
         player_name == "Luka Doncic" |
         player_name == "Kawhi Leonard" |
         player_name == "Nikola Jokic" |
         player_name == "Damian Lillard" |
         player_name == "Chris Paul" |
         player_name == "Pascal Siakam" |
         player_name == "Jayson Tatum" |
         player_name == "Jimmy Butler" |
         player_name == "Rudy Gobert" |
         player_name == "Ben Simmons" |
         player_name == "Russell Westbrook") 

all_nba <- all_nba %>% 
  filter(season_type== "RS")

ggplot(data = all_nba) + geom_bar(aes(player_name, raptor_total, 
                                      fill = player_name, xaxt=FALSE), stat = "identity")+theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank()) +
  labs(title = "Members of the All NBA Teams Total Raptor", 
       y = "Total Raptor Grade",
       fill = "Player Name")

ggplot(data = all_nba) +
  geom_bar(aes(player_name, war_reg_season, fill = player_name, xaxt=FALSE), 
           stat = "identity")+theme(axis.title.x=element_blank(),
                                    axis.text.x=element_blank(), 
                                    axis.ticks.x=element_blank()) +
  labs(title = "Members of the All NBA Teams' WAR",
       fill = "Player Name", y = "WAR")



###Visualisation

player_type_data <- nba_players %>%
  filter(player_type != "NA")
  
ggplot(data=player_type_data, aes(x=player_type, y=pace_impact))+geom_violin() +
  labs(title = "Offensive and Two Way Players Play at a Faster Pace",
  subtitle = " Compaired to Defensive and No Way Players",
  y = "Pace of Play Impact", x = "Player Type")






```

Explanations:

Graph 1: Graph one shows the distribution of NBA players comparing both their 
offensive and defensive raptor. Each point represents one player and their 
raptors. The first graph shows the players in this years playoffs, and there
seems to be more outliers in it. In both graphs, there looks to be a large 
clump at the axis, meaning that the majority of the NBA has both an offensize 
and defensive raptor around zero. 

Graph 2: Graph two depicts the member of the three all NBA Teams and their 
total raptors. It is interesting to see that three of the players who
were awarded this honor had a negative total raptor. Rudy Gobert and Russell
Westbrook were members of the All NBA Third Team, so if any of these players
would have negative total raptors it would be them, but Chris Paul's negative
raptor total is surprising. It is also interesting to notice that James Harden
had the highest total raptor, because he is a player known for his incredible 
offense, but very lackluster defense. I would have expected his bad defense
to even out his great offensive raptor, but it did not. His total raptor is 
just over 5 points higher than the MVP Giannis Antetakounmpo.

Graph 3: Graph three shows the WAR of all 15 members of the All-NBA teams. It is
obvious who the league MVP was (Giannis Antetakounmpo) with a WAR well above 
anyone else. What makes this graph interesting is that outside of Antetakounmpo.



Graph 4: Graph three depicts the pace of play by player type. A defensive 
player is a player with a good defensive raptor, a no way player is not
great at either, an offensive player has a good offensive raptor, and a two
way player has a good offensive and defensive raptor. The offensive and two
way players often look to score and play at a fast pace, which this violin
plot clearly shows. The defensive players want to slow the game down and
force the offensive player to be uncomfortable and play slow. The no way
players are often role players, meaning that they do not affect the pace
of the game enough to make it much faster.





### 7: Defense

1. Testing if better defensive players have a better WAR in the 
playoffs and regular season.

$H_0$: Better defensive players have the same mean WAR in the regular
season and playoffs as average or below average defenders.

$H_1$: Better defensive players have the better mean WAR in the 
regular season and playoffs than average or below average defenders.

```{r war cor test}

#linear model tests
exp_war_reg <- lm(war_reg_season ~ raptor_defense + raptor_offense, 
              data = nba_players)
tidy(exp_war_reg)

#Conditions test


aug_reg <- augment(exp_war_reg)
aug_reg %>%
  slice(1:3)

#ggplot(data = aug_reg, 
       #aes(x = 1:nrow(nba_players), 
           #y = .resid)) + 
  #geom_point() + 
  #labs(x = "Index", y = "Residual")

ggplot(aug_reg, mapping = aes(x = .fitted, y = .resid)) +
  geom_point() + 
  geom_hline(yintercept = 0, lwd = 2, col = "red", lty = 2) +
  labs(x = "Predicted Price", y = "Residuals")

ggplot(aug_reg, mapping = aes(x = .resid)) +
  geom_histogram(bins = 15) + 
  labs(x = "Residuals")

ggplot(aug_reg, mapping = aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line()
```

Expected regular season WAR = 1.70 + 0.142 * Defensive RAPTOR + 0.306 * 
Offensive Raptor

This means that offensive efficiency is actually more important to WAR (wins 
above replacement) than defensive efficiency. The nature of the league has 
definitely changed. Defense used to be the heart and soul of any NBA team, but
now with such high scoring games, the importance of efficient offense seems to
outweigh the importance of efficient defense. 

### 8: Offensive

1. Testing to see whether being a purely offensive leads to higher mean impact.
Method: CLT-based approach

$H_0$: Mean pace_impact when player can play offensive ("Offensive" or "Two-way)
= mean pace_impact when player cannot play offensive but could be "Defensive", 
or "No Way".

$H_1$: Mean pace_impact when player can play offensive 
("Offensive" or "Two-way)> mean pace_impact when player cannot play offensive 
but could be "Defensive", or "No Way".

$/alpha$=0.05

```{r}
nba_players_offense <- nba_players %>%
  mutate(offense=ifelse(raptor_offense > 0, 1, 0))

t.test(pace_impact ~ offense, 
       data = nba_players_offense, 
       var.equal = FALSE,
       alternative = "greater", 
       conf.level = 0.95)
```


Since our P-value of 0.4793 is greater than the alpha level of 0.05, we fail to 
reject the null hypothesis. Since we conducted this test on our population, we 
can say that being able to play offensively does not lend to having a higher
impact on player possessions every 48 minutes. 


### 9: Correlation- RaptoTotal and Winning Percentage

2. Do the players on the team's raptor total correlate to the teams winning
percentage?

```{r making data setex-2, message = FALSE, warning = FALSE}
team_data_rap <- nba_players %>%
  select(team, team_win_pc, raptor_total) %>%
  group_by(team) %>%
  summarise(avg_rap = mean(raptor_total))

team_win_pct_data <- nba_players %>%
  select(team) %>%
  mutate(team_win_pc = case_when(
    team == "MIL" ~ .767,
    team == "TOR" ~ .736,
    team == "BOS" ~ .667,
    team == "IND" ~ .616,
    team == "MIA" ~ .603,
    team == "PHI" ~ .589,
    team == "BRK" ~ .486,
    team == "ORL" ~ .452,
    team == "WAS" ~ .347,
    team == "CHA" ~ .354,
    team == "CHI" ~ .338,
    team == "NYK" ~ .318,
    team == "DET" ~ .303,
    team == "ATL" ~ .299,
    team == "CLE" ~ .292,
    team == "LAL" ~ .732,
    team == "LAC" ~ .681,
    team == "DEN" ~ .630,
    team == "HOU" ~ .611,
    team == "OKC" ~ .611,
    team == "UTA" ~ .611,
    team == "DAL" ~ .573,
    team == "POR" ~ .473,
    team == "MEM" ~ .466,
    team == "PHO" ~ .466,
    team == "SAS" ~ .451,
    team == "SAC" ~ .431,
    team == "NOP" ~ .417,
    team == "MIN" ~ .297,
    team == "GSW" ~ .231
  )) %>% 
  distinct()

team_data <- inner_join(team_data_rap, team_win_pct_data, by = "team")

ggplot(data = team_data, aes(x = team_win_pc, y= avg_rap)) +geom_point() +
  labs(title = "There are predominantly teams with negative avergae raptor",
       subtitle = "Only five teams that fit the positive raptor, above .500 
       winning percentage", 
       y= "Average Raptor", x = "Team Winning Percantage")

lm_team <- lm(team_win_pc ~ avg_rap, data = team_data)
tidy(lm_team)

aug_reg <- augment(lm_team)
aug_reg %>%
  slice(1:3)

ggplot(aug_reg, mapping = aes(x = .fitted, y = .resid)) +
  geom_point() + 
  geom_hline(yintercept = 0, lwd = 2, col = "red", lty = 2) +
  labs(x = "Predicted Winning Percentage", y = "Residuals")

ggplot(aug_reg, mapping = aes(x = .resid)) +
  geom_histogram(bins = 15) + 
  labs(x = "Residuals")

ggplot(aug_reg, mapping = aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line()




```

Expected team winning percentage = 0.52338 + 0.03233(team average raptor)

For every single unit increase in team average raptor, it is expected there will
be an increase in winning percentage of 3.23%.

We tested for equal variance and linearity first. Overall we observed a roughly
linear and equal variance relationship in our data points. Next, we tested for
normality using a QQ plot. This came out less fitting, but we realized there are
only 30 data points so it is expected that the tests won't exactly fit. 

