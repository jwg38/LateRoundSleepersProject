---
title: "Final Project Draft"
subtitle: "due Thursday, Oct 29 at 11:59p"
author: "Late Round Sleepers: Alex Jackson, Evan Finley, Jack White, Aliya Kamran"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Environment and Libraries

```{r environ}
library(tidyverse)
nba_players <- read.csv("https://projects.fivethirtyeight.com/nba-model/2020/latest_RAPTOR_by_team.csv")
```

### 1: Introduction

We are investigating what makes NBA players successful in various seasons. We
are all NBA fans and looking into statistics about the NBA will allow us to 
have a better understanding for the game and make us more informed. 
Basketball statistics are fairly new and it will be interesting to discover if
our perceived notions of certain players match the statistical data. 

In particular, we want to test the following hypothesis and questions:

If defensive or offensive efficiency affects winning percentage the
most.

Better defensive players have a better winning percentage in the playoffs and 
regular season.

Players who score the most do not have the highest winning percentage.

Players who have the most offensive possessions win more games.

Sources:
https://fivethirtyeight.com/features/introducing-raptor-our-new-metric-for-the-modern-nba/


### 2: Data description


We wish to explore the NBA-Raptor data set. Raptor is a player efficiency rating 
system.This data set has tracked multiple team and player analysis over a six 
year period. Each observation is an NBA player with variables about their 
statistics. It has variables such as players points per game, team winning 
percentage, average team possessions per game, and many more. The player data
is stats from every NBA games since 2014. Raptor was made by Fivethirtyeight. 


### 3: Glimpse of data

```{r glimpse}
glimpse(nba_players)
```

### 4: Methodology

The methodology section should include the variables used to address your research question, as well as any useful visualizations or summary statistics. As well, you should introduce and justify the statistical method(s) that you believe will be useful in answering your research question.


### 5: Results

Showcase how you arrived at answers to your question using any techniques we have learned in this class (and some beyond, if youâ€™re feeling adventurous). Provide the main results from your analysis. The goal is not to do an exhaustive data analysis (i.e., do not calculate every statistic and procedure you have learned for every variable), but rather let me know that you are proficient at asking meaningful questions and answering them with results of data analysis, that you are proficient in using R, and that you are proficient at interpreting and presenting the results. Focus on methods that help you begin to answer your research questions.


### 6: Adding Variables and Cleaning Data

```{r variables}
nba_players <- nba_players %>% 
  filter(war_reg_season != 0) 

mean_war <- nba_players %>% 
  summarise(mean_war = mean(war_reg_season))
mean_war


nba_players <- nba_players %>% 
  mutate(war_reg_good = case_when(war_reg_season > mean_war ~ TRUE,
                                  war_reg_season <= mean_war ~ FALSE),
         player_type = case_when(raptor_offense > 0 & raptor_defense > 0 ~ 
                                   "Two-way",
                                raptor_offense > 0 & raptor_defense < 0 ~ 
                                  "Offensive",
                                raptor_offense < 0 & raptor_defense > 0 ~ 
                                  "Defensive",
                                raptor_offense < 0 & raptor_defense < 0 ~ 
                                  "No-way"))
```

Added the following variables to our dataset:

war_reg_good: mean wins for regular season are above 0 or not. 

player_type: categorising the player as offensive, defensive etc.

```{r team-win-pc}
nba_players <- nba_players %>%
  mutate(team_win_pc = case_when(
    team == "MIL" ~ .767,
    team == "TOR" ~ .736,
    team == "BOS" ~ .667,
    team == "IND" ~ .616,
    team == "MIA" ~ .603,
    team == "PHI" ~ .589,
    team == "BRK" ~ .486,
    team == "ORL" ~ .452,
    team == "WAS" ~ .347,
    team == "CHA" ~ .354,
    team == "CHI" ~ .338,
    team == "NYK" ~ .318,
    team == "DET" ~ .303,
    team == "ATL" ~ .299,
    team == "CLE" ~ .292,
    team == "LAL" ~ .732,
    team == "LAC" ~ .681,
    team == "DEN" ~ .630,
    team == "HOU" ~ .611,
    team == "OKC" ~ .611,
    team == "UTA" ~ .611,
    team == "DAL" ~ .573,
    team == "POR" ~ .473,
    team == "MEM" ~ .466,
    team == "PHO" ~ .466,
    team == "SAS" ~ .451,
    team == "SAC" ~ .431,
    team == "NOP" ~ .417,
    team == "MIN" ~ .297,
    team == "GSW" ~ .231
  ))
           
```

### 7: Defense

1. Testing if better defensive players have a better WAR in the 
playoffs and regular season.

$H_0$: Better defensive players have the same mean WAR in the regular
season and playoffs as average or below average defenders.

$H_1$: Better defensive players have the better mean WAR in the 
regular season and playoffs than average or below average defenders.

```{r war cor test}
nba_players <- nba_players %>% 
  mutate(log_war_reg = log(war_reg_season)) 

#checking mean WAR
mean_war <- nba_players %>% 
  summarise(mean_war = mean(log_war_reg))
mean_war

mean_war_po <- playoff_players %>% 
  summarise(mean_war = mean(war_playoffs))
mean_war_po

ggplot(data = nba_players, aes(x = raptor_defense, y = raptor_offense)) +
  geom_point() + geom_hline(yintercept = 0, lwd = 1, col = "red", lty = 2) +
  geom_vline(xintercept = 0, lwd = 1, col = "red", lty = 2)


#linear model tests
exp_war_reg <- lm(log_war_reg ~ raptor_defense + raptor_offense, 
              data = nba_players)
tidy(exp_war_reg)

#Conditions test


aug_reg <- augment(exp_war_reg)
aug_reg %>%
  slice(1:3)

ggplot(data = aug_reg, 
       aes(x = 1:nrow(nba_players), 
           y = .resid)) + 
  geom_point() + 
  labs(x = "Index", y = "Residual")

ggplot(aug_reg, mapping = aes(x = .fitted, y = .resid)) +
  geom_point() + 
  geom_hline(yintercept = 0, lwd = 2, col = "red", lty = 2) +
  labs(x = "Predicted Price", y = "Residuals")

ggplot(aug_reg, mapping = aes(x = .resid)) +
  geom_histogram(bins = 15) + 
  labs(x = "Residuals")

ggplot(aug_reg, mapping = aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line()

exp_war_po <- lm(war_playoffs ~ raptor_defense + raptor_offense, 
              data = playoff_players)
tidy(exp_war_po)
```

Expected regular season WAR = 1.70 + 0.142 * Defensive RAPTOR + 0.306 * 
Offensive Raptor

Expected playoff WAR = 0.470 + 0.104 * Defensive RAPTOR + 0.152 * Offensive 
Raptor

This means that offensive efficiency is actually more important to WAR (wins 
above replacement) than defensive efficiency in both the regular season and 
playoffs.

### 8: Offensive

1. Testing to see whether being a purely offensive leads to higher mean impact.
Method: CLT-based approach

$H_0$: Mean pace_impact when player can play offensive ("Offensive" or "Two-way)
= mean pace_impact when player cannot play offensive but could be "Defensive", 
or "No Way".

$H_1$: Mean pace_impact when player can play offensive 
("Offensive" or "Two-way)> mean pace_impact when player cannot play offensive 
but could be "Defensive", or "No Way".

$/alpha$=0.05

```{r}
nba_players_offense <- nba_players %>%
  mutate(offense=ifelse(raptor_offense > 0, 1, 0))

t.test(pace_impact ~ offense, 
       data = nba_players_offense, 
       var.equal = FALSE,
       alternative = "greater", 
       conf.level = 0.95)
```


Since our P-value of 0.4793 is greater than the alpha level of 0.05, we fail to 
reject the null hypothesis. Since we conducted this test on our population, we 
can say that being able to play offensively does not lend to having a higher
impact on player possessions every 48 minutes. 


### 9: Correlation- RaptoTotal and Winning Percentage

2. Do the players on the team's raptor total correlate to the teams winning
percentage?

```{r making data setex-2}
data_for_ex_2 <- nba_players %>%
  select(player_name, team, raptor_total, team_win_pc) 


```

```{r ex-2}
mil_data <- data_for_ex_2 %>%
  filter(team == "MIL") %>%
  mutate(team_average_total_raptor = case_when(
    team == "MIL" ~ mean(raptor_total)
  ))

raptors_data <- data_for_ex_2 %>%
  filter(team == "TOR") %>%
  mutate(team_average_total_raptor = case_when(
    team == "TOR" ~ mean(raptor_total)
  ))

celtics_data <- data_for_ex_2 %>%
  filter(team == "BOS") %>%
  mutate(team_average_total_raptor = case_when(
    team == "BOS" ~ mean(raptor_total)
  ))

pacers_data <- data_for_ex_2 %>%
  filter(team == "IND") %>%
  mutate(team_average_total_raptor = case_when(
    team == "IND" ~ mean(raptor_total)
  ))

lakers_data <- data_for_ex_2 %>%
  filter(team == "LAL") %>%
  mutate(team_average_total_raptor = case_when(
    team == "LAL" ~ mean(raptor_total)
  ))

clippers_data <- data_for_ex_2 %>%
  filter(team == "LAC") %>%
  mutate(team_average_total_raptor = case_when(
    team == "LAC" ~ mean(raptor_total)
  ))

nuggets_data <- data_for_ex_2 %>%
  filter(team == "DEN") %>%
  mutate(team_average_total_raptor = case_when(
    team == "DEN" ~ mean(raptor_total)
  ))

rockets_data <- data_for_ex_2 %>%
  filter(team == "HOU") %>%
  mutate(team_average_total_raptor = case_when(
    team == "HOU" ~ mean(raptor_total)
  ))

```

```{r combining data sets}
total_data_ex_2 <-rbind(rockets_data, nuggets_data, clippers_data, lakers_data,
                        pacers_data, celtics_data, raptors_data, mil_data)

```

```{r correlation between team win pct and team average raptor}
total_data_ex_2 %>%
  summarise(cor_team_win_team_raptor = cor(team_win_pc, team_average_total_raptor))



```

```{r}

boot_dist = numeric(1000)

for(i in 1:1000){
  set.seed(i)
  indices <- sample(1:nrow(total_data_ex_2), replace = TRUE)
  
  boot_mean_2 <- total_data_ex_2 %>%
    slice(indices) %>%
    summarise(cor_team_win_team_raptor = cor(team_win_pc, team_average_total_raptor)) %>%
    pull()
  boot_dist[i] <- boot_mean_2
  
  boot_mean_2 <- tibble(boot_dist)
  
  confidence_interval_2 <- boot_mean_2 %>%
       summarize(lower = quantile(boot_dist, 0.005),
                upper = quantile(boot_dist, 0.995))
}

confidence_interval_2
```

```{r}
ggplot(data = boot_mean_2, aes(x = boot_dist)) +
  geom_histogram(binwidth = .007) +
  labs(title = "Bootstrap Distribution of Correlation between team Win Percentage 
       and AverageTeam Raptor", subtitle = "Between the top 4 teams in each 
       conference",
       x = "Correlation") +
  geom_vline(xintercept = c(confidence_interval_2$lower, 
                            confidence_interval_2$upper),
             lwd = 2, color = "red")


```

There is a weak correlation between team total raptor and team winning percentage.

### 10 Top Defensive Teams and Winning Percentage
I am going to look at the mean team raptor defense for the 4 best teams in the
NBA and the four worst teams in the NBA and see how they differ. (Then
we should do the same with offense!!)


```{r}
data_for_ex_3 <- nba_players %>%
  select(team, team_win_pc, raptor_defense)

```

```{r mutating data}

data_for_ex_3 <- data_for_ex_3 %>%
  filter(team == "MIL") %>%
  mutate(team_average_defensive_raptor = case_when(
    team == "MIL" ~ mean(raptor_defense)
  ))

data_for_ex_3 <- data_for_ex_3 %>%
  filter(team == "TOR") %>%
  mutate(team_average_defensive_raptor = case_when(
    team == "TOR" ~ mean(raptor_defense)
  ))

data_for_ex_3 <- data_for_ex_3 %>%
  filter(team == "LAL") %>%
  mutate(team_average_defensive_raptor = case_when(
    team == "LAL" ~ mean(raptor_defense)
  ))

data_for_ex_3 <- data_for_ex_2 %>%
  filter(team == "LAC") %>%
  mutate(team_average_defensive_raptor = case_when(
    team == "LAC" ~ mean(raptor_defense)
  ))
